<!doctype html>
<html><head><title>STARS DEMO - officine tesla</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.js">
</script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<style>html,body{overflow:hidden;margin:0;padding:0;height:100%;width:100%;}
#infoview{position:absolute;z-index:100;top:0px;padding-left:20px;background-color:rgba(255,255,255,0.5);}
#controls{position:absolute;z-index:100;top:20px;padding-left:20px;background-color:transparent;}
#loading{position:absolute;z-index:100;top:0px;left:0;height:100%;width:100%;padding-left:20px;background-color:transparent;}</style>
<script>
function myload(){
var three = THREE;var scene=new three.Scene();
var objects = [];
var camera = new three.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
var renderer = new three.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

var geometry = new three.BoxGeometry(1, 1, 1);
three.ImageUtils.crossOrigin = '';
var material = new THREE.MeshBasicMaterial({color: 0xF0ff00 } );
var star = new three.Mesh(geometry, material);
var linematerial = new THREE.LineBasicMaterial({color: 0xff0000});
camera.position.z = 0.005;

app.addconstellation=function(name){for(var l=0;l<app.HAY.asterisms[name].length;l++){if(app.HAY.asterisms[name][l]){app.addline(app.HAY.asterisms[name][l],name);}}};
app.addline=function(L,CN){var newline=new THREE.Geometry();var D;var sidx;
	for(var s=0;s<L.length;s++){if(L[s]){if(L[s]!='null'){sidx=app.HAY.names[L[s].toLowerCase()];if(sidx){app.addstar(sidx);
		D=app.HAY.stars[sidx];if(D){app.HAY.stars[sidx][5]=CN;newline.vertices.push(new THREE.Vector3(D[0],D[1],D[2]));}
		}}}}
	scene.add(new THREE.Line(newline,linematerial));};	
app.addstar=function(idx){var D=app.HAY.stars[idx];if(D){var star2=star.clone();star2.position.setX(D[0]);star2.position.setY(D[1]);star2.position.setZ(D[2]);
	/*star2.scale.set(D[3],D[3],D[3]);*/star2.AppData={t:'star',idx:idx};scene.add(star2);objects.push(star2);}};

var isDragging = false;var previousMousePosition = { x: 0, y: 0};
var raycaster = new THREE.Raycaster();var mouse = new THREE.Vector2();
$(renderer.domElement).on('mousedown', function(e) {var flag=false;
	/*Check clicked object*/
	var rect = renderer.domElement.getBoundingClientRect();
	mouse.x=((e.clientX-rect.left)/(rect.width-rect.left))*2-1;
	mouse.y=-((e.clientY-rect.top)/(rect.bottom-rect.top))*2+1;
	raycaster.setFromCamera(mouse,camera);
    intersects = raycaster.intersectObjects(objects);
    if(intersects.length>0){var idx=intersects[0].object.AppData.idx;var d=app.HAY.stars[idx];
        document.getElementById('infoview').innerHTML='['+d[5]+'] - Name: '+d[4].substring(0,d[4].length-1)+' - Magnitude: '+d[3]+' - Hipparcos Catalog Number: '+idx+' - ['+d[0]+','+d[1]+','+d[2]+']';}
	/*Start dragging*/
	if(!flag){isDragging = true;}
})
.on('mousemove', function(e) {
    var deltaMove={x: e.offsetX-previousMousePosition.x,y: e.offsetY-previousMousePosition.y};
    if(isDragging) {            
        var deltaRotationQuaternion = new three.Quaternion()
            .setFromEuler(new three.Euler(toRadians(deltaMove.y * 1),toRadians(deltaMove.x * 1),0,'XYZ'));        
        scene.quaternion.multiplyQuaternions(deltaRotationQuaternion, scene.quaternion);
    }
    previousMousePosition={x: e.offsetX,y: e.offsetY};
}).on('DOMMouseScroll mousewheel', function(e) {
	var wd=e.originalEvent.wheelDelta;var dir=1;if(wd>0){dir=-1}
	camera.position.z=camera.position.z+((dir*0.5)*camera.position.z);
});
$(document).on('mouseup', function(e) {isDragging = false;});

// shim layer with setTimeout fallback
window.requestAnimFrame = (function(){
    return  window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        function(callback) {
            window.setTimeout(callback, 1000 / 60);
        };
})();
function render(){renderer.render(scene, camera);requestAnimFrame(render);};app.render=function(){render();}
function toRadians(angle){return angle*(Math.PI/180);}function toDegrees(angle){return angle*(180/Math.PI);}

app.reset=function(){camera.position.z=0.001;scene.quaternion.set(0.5001856125531934,-0.415030000105589,0.6652291136014553,-0.36747064974525334);};
app.DATALOAD();
};


window.app={};
app.HAY={};app.HAY.stars={length:0};app.HAY.names={};
app.dataloaded1=false;app.dataloaded2=false;app.dataloaded3=false;
app.DATALOAD=function(){
/* Read stars.dat into app.HAY.stars */
var xhr1 = new XMLHttpRequest();
xhr1.open("GET", "https://cdn.rawgit.com/CelestiaProject/Celestia/401673d1/data/stars.dat"); 
xhr1.responseType = "blob";
xhr1.onload = function(){var reader = new FileReader();reader.onloadend = function(evt) {	  
		var BB=evt.target.result;var NN;var MM;var AA;var n=1;var max=BB.byteLength-21;var len=0;  
		for(var b=0;n<(max/20);b+=20){
			NN=new Int32Array(BB,b,4);MM=new Int16Array(BB,b+16,2);AA=new Float32Array(BB,b+4,12);
			app.HAY.stars[NN[0]]=[AA[0],AA[1],AA[2],MM[0]/256,''];n++;app.HAY.stars.length++;
	}app.dataloaded1=true;app.DATALOADED();};
    var blob = xhr1.response;blob=blob.slice(14, blob.size);
    reader.readAsArrayBuffer(blob);	
};xhr1.send();
/* Read starnames.dat into app.HAY.starnames */
var xhr2 = new XMLHttpRequest();xhr2.open("GET", "https://cdn.rawgit.com/CelestiaProject/Celestia/401673d1/data/starnames.dat"); 
xhr2.responseType = "blob";//force the HTTP response, response-type header to be blob
xhr2.onload = function(){var reader = new FileReader();reader.onloadend = function(evt) { 
		var NAMES=evt.target.result.split('\n');var t='';var m;var tn='';
		for(var n=0;n<NAMES.length;n++){t=NAMES[n].split(':');
			for(m=1;m<t.length;m++){app.HAY.names[t[m].toLowerCase()]=t[0];}
		}app.dataloaded2=true;app.DATALOADED();};
    var blob = xhr2.response;reader.readAsText(blob);	
};xhr2.send();
/* Read asterism.dat into app.HAY.asterisms */
var xhr3 = new XMLHttpRequest();xhr3.open("GET", "https://cdn.rawgit.com/CelestiaProject/Celestia/401673d1/data/asterisms.dat"); 
xhr3.responseType = "blob";//force the HTTP response, response-type header to be blob
xhr3.onload = function(){var reader = new FileReader();reader.onloadend = function(evt) { 
		var RSPTEXT=evt.target.result
		.replace(/Alpha/g,'ALF').replace(/Beta/g,'BET').replace(/Gamma/g,'GAM')
		.replace(/Delta/g,'DEL').replace(/Epsilon/g,'EPS').replace(/Iota/g,'IOT')
		.replace(/Kappa/g,'KAP').replace(/Lambda/g,'LAM').replace(/Omega/g,'OME')
		.replace(/Omicron/g,'OMI').replace(/Sigma/g,'SIG').replace(/Theta/g,'TET')
		.replace(/Upsilon/g,'UPS').replace(/Zeta/g,'ZET')		
		.replace(/\n\n/g,'\n').replace(/\n\n/g,'\n').replace(/] /g,']')
		.replace(/"\n\[/g,'":[').replace(/]\n]/g,']],\n')
		.replace(/\[ "/g,'["').replace(/" ]/g,'"]')
		.replace(/]\n\[/g,'],\n[').replace(/]\n\[/g,'],\n[')
		.replace(/  /g,' ').replace(/" "/g,'","').replace(/"\n "/g,'","').replace(/]\[/g,'],[');
		RSPTEXT='app.HAY.asterisms={'+RSPTEXT+'};';eval(RSPTEXT);
		app.dataloaded3=true;app.DATALOADED();};
    var blob = xhr3.response;reader.readAsText(blob);	
};xhr3.send();};
app.DATALOADED=function(err){if(app.dataloaded1&&app.dataloaded2&&app.dataloaded3){
		for(var m in app.HAY.names){try{app.HAY.stars[app.HAY.names[m]][4]+=m+','}catch(ex){console.log(m+'-'+app.HAY.names[m]);}}
		console.log('Data loaded');
		for(var z=0;z<ZODIAC.length;z++){app.addconstellation(ZODIAC[z])}
		app.render();
		document.getElementById('loading').style.display='none';
		document.getElementById('controls').style.display='initial';
}};
window.ZODIAC=["Aquarius","Aries","Cancer","Capricornus","Corona Australis","Corona Borealis","Gemini","Leo","Libra","Orion","Pisces","Sagittarius","Scorpius","Taurus","Ursa Major","Ursa Minor","Virgo"];
</script>
</head><body onload="myload()";><div id="infoview" style="color:#eeeeee;font-weight:bold;"> </div><div id="loading" style="color:#eeeeee;font-weight:bold;">loading resources from https://cdn.rawgit.com/CelestiaProject/Celestia/ ...<br/><a href="https://github.com/officinetesla/stars">https://github.com/officinetesla/stars</a></div><div id="controls" style="color:#eeeeee;font-weight:bold;" style="display:none"><a href="https://github.com/officinetesla/stars">https://github.com/officinetesla/stars</a><br/>
CLICK on stars for more info<br/>DRAG to rotate, SCROLL to zoom out!<br/><button onclick="app.reset()">reset</button></div></body></html>
